<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sentinel Ops</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#0f172a">
    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#0f172a] text-slate-200 font-sans h-screen overflow-hidden flex">

    <!-- Login Overlay (shows when trying to access protected chats) -->
    <div id="login-overlay" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-slate-700">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-2xl font-bold flex items-center">
                    <i data-lucide="lock" class="w-6 h-6 mr-2 text-blue-500"></i>
                    Login Required
                </h2>
                <button onclick="hideLoginOverlay()" class="text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <p class="text-slate-400 mb-6">Please login to access custom chat channels</p>
            
            <!-- Login Form -->
            <form id="login-form" onsubmit="login(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Username</label>
                    <input type="text" id="login-username" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter username" />
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">Password</label>
                    <input type="password" id="login-password" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Enter password" />
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-semibold transition-all">
                    Login
                </button>
            </form>

            <!-- 2FA Verification Form (Hidden initially) -->
            <form id="login-2fa-form" onsubmit="verifyLogin2FA(event)" class="hidden space-y-4">
                <div class="text-center mb-4">
                    <div class="bg-blue-500/10 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i data-lucide="shield-check" class="w-8 h-8 text-blue-500"></i>
                    </div>
                    <h3 class="text-lg font-semibold">Two-Factor Authentication</h3>
                    <p class="text-sm text-slate-400">Enter the 6-digit code from your authenticator app</p>
                </div>
                <div>
                    <input type="text" id="login-2fa-code" maxlength="6" pattern="[0-9]{6}" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-center text-2xl tracking-widest font-mono focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="000000" />
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-semibold transition-all">
                    Verify
                </button>
                <button type="button" onclick="cancel2FALogin()" class="w-full text-slate-400 hover:text-white text-sm">
                    Back to Login
                </button>
            </form>

            <div id="login-error" class="hidden mt-4 p-3 bg-red-900/50 border border-red-700 rounded-lg text-red-300 text-sm"></div>
        </div>
    </div>

    <!-- User Profile Modal -->
    <div id="profile-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div class="bg-slate-800 p-8 rounded-xl shadow-2xl max-w-md w-full mx-4 border border-slate-700">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold flex items-center">
                    <i data-lucide="user" class="w-6 h-6 mr-2 text-blue-500"></i>
                    User Profile
                </h2>
                <button onclick="hideProfileModal()" class="text-slate-400 hover:text-white">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <div class="space-y-6">
                <!-- Profile Info -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Username</label>
                        <div class="flex space-x-2">
                            <input type="text" id="profile-username" class="flex-1 bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                            <button onclick="updateUsername()" class="bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-xs font-bold">Update</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Role</label>
                        <div id="profile-role" class="text-slate-300 font-mono bg-slate-900/50 px-3 py-2 rounded-lg border border-slate-800"></div>
                    </div>
                </div>

                <div class="h-px bg-slate-700"></div>

                <!-- Security Settings -->
                <div>
                    <h3 class="text-sm font-bold text-white mb-3">Security</h3>
                    <div class="space-y-3">
                        <button onclick="showChangePasswordModal()" class="w-full flex items-center justify-between bg-slate-700/50 hover:bg-slate-700 p-3 rounded-lg border border-slate-600/50 transition-all">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="key" class="w-4 h-4 text-slate-400"></i>
                                <span class="text-sm">Change Password</span>
                            </div>
                            <i data-lucide="chevron-right" class="w-4 h-4 text-slate-500"></i>
                        </button>
                        
                        <div class="flex items-center justify-between bg-slate-700/50 p-3 rounded-lg border border-slate-600/50">
                            <div class="flex items-center space-x-3">
                                <i data-lucide="shield" class="w-4 h-4 text-slate-400"></i>
                                <div>
                                    <div class="text-sm font-medium">Two-Factor Auth</div>
                                    <div id="profile-2fa-status" class="text-xs text-slate-500">Disabled</div>
                                </div>
                            </div>
                            <button id="btn-toggle-2fa" onclick="toggle2FA()" class="text-xs font-bold px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-white">
                                Setup
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="profile-message" class="hidden mt-4 p-3 rounded-lg text-sm text-center"></div>
        </div>
    </div>

    <!-- Change Password Modal -->
    <div id="password-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-700">
            <h3 class="text-lg font-bold mb-4">Change Password</h3>
            <form onsubmit="changePassword(event)" class="space-y-3">
                <input type="password" id="pwd-old" placeholder="Current Password" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                <input type="password" id="pwd-new" placeholder="New Password (min 8 chars)" required minlength="8" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                <input type="password" id="pwd-confirm" placeholder="Confirm New Password" required minlength="8" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-sm" />
                <div class="flex space-x-2 pt-2">
                    <button type="button" onclick="hideChangePasswordModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg text-sm font-bold">Save</button>
                </div>
            </form>
            <div id="pwd-error" class="hidden mt-3 text-red-400 text-xs text-center"></div>
        </div>
    </div>

    <!-- 2FA Setup Modal -->
    <div id="2fa-setup-modal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="bg-slate-800 p-6 rounded-xl shadow-2xl max-w-sm w-full mx-4 border border-slate-700">
            <h3 class="text-lg font-bold mb-2">Setup 2FA</h3>
            <p class="text-xs text-slate-400 mb-4">Scan this QR code with Google Authenticator or Authy</p>
            
            <div class="bg-white p-2 rounded-lg w-fit mx-auto mb-4">
                <img id="2fa-qr-code" src="" alt="QR Code" class="w-48 h-48" />
            </div>
            
            <div class="mb-4 text-center">
                <p class="text-[10px] text-slate-500 uppercase tracking-wider mb-1">Secret Key</p>
                <code id="2fa-secret" class="bg-slate-900 px-2 py-1 rounded text-xs font-mono text-blue-400 select-all"></code>
            </div>

            <form onsubmit="enable2FA(event)" class="space-y-3">
                <input type="text" id="2fa-verify-code" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}" required class="w-full bg-slate-900 border border-slate-700 rounded-lg px-3 py-2 text-center text-lg tracking-widest font-mono" />
                <div class="flex space-x-2">
                    <button type="button" onclick="hide2FASetupModal()" class="flex-1 bg-slate-700 hover:bg-slate-600 py-2 rounded-lg text-sm">Cancel</button>
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-500 py-2 rounded-lg text-sm font-bold">Enable</button>
                </div>
            </form>
            <div id="2fa-error" class="hidden mt-3 text-red-400 text-xs text-center"></div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="w-72 bg-[#0B1120] border-r border-slate-800 flex flex-col flex-shrink-0 z-20 shadow-xl">
        <div class="h-16 px-6 border-b border-slate-800 flex items-center space-x-3 bg-[#0B1120]">
            <div class="bg-blue-600 p-2 rounded-lg shadow-lg shadow-blue-900/20">
                <i data-lucide="shield" class="text-white w-5 h-5"></i>
            </div>
            <span class="font-bold text-white text-xl tracking-tight">SENTINEL</span>
        </div>

        <div class="flex-1 overflow-y-auto py-6 px-3 space-y-6">
            <div>
                <div class="px-3 mb-2 text-[11px] font-bold text-slate-500 uppercase tracking-widest">Operations Feed</div>
                <div class="space-y-1" id="channel-list">
                    <!-- Channels injected by JS -->
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-slate-800 bg-[#0B1120]">
            <button onclick="switchChannel('integration')" id="btn-integration" class="w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-lg text-sm font-medium transition-all bg-slate-800/50 text-slate-400 hover:bg-slate-800 hover:text-white">
                <i data-lucide="terminal" class="w-4 h-4"></i>
                <span>API Integration</span>
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-full relative">
        <!-- Header -->
        <div class="h-16 border-b border-slate-800 bg-[#0f172a]/80 backdrop-blur-md flex items-center justify-between px-6 sticky top-0 z-10">
            <div class="flex items-center space-x-4 flex-1">
                <h2 class="text-lg font-bold flex items-center text-white">
                    <i data-lucide="hash" class="mr-2 text-slate-500 w-5 h-5" id="header-icon"></i>
                    <span id="header-title">General</span>
                </h2>
                <div class="h-4 w-px bg-slate-700"></div>
                <div class="flex items-center space-x-2 px-3 py-1 bg-slate-800/50 rounded-full border border-slate-700/50">
                    <div id="status-dot" class="w-2 h-2 rounded-full bg-yellow-500 animate-pulse"></div>
                    <span id="status-text" class="text-[10px] uppercase tracking-wider font-bold text-slate-400">Connecting...</span>
                </div>
                
                <!-- Search Bar -->
                <div id="search-container" class="flex-1 max-w-md ml-auto">
                    <div class="relative">
                        <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input 
                            type="text" 
                            id="search-input" 
                            placeholder="Search alerts..." 
                            class="w-full bg-slate-800/50 border border-slate-700 rounded-lg pl-10 pr-4 py-2 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        />
                    </div>
                </div>
            </div>
            
            <button onclick="sendTestAlert()" id="test-btn" class="flex items-center space-x-2 bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold py-2 px-4 rounded-lg transition-all shadow-lg shadow-blue-900/20 hover:shadow-blue-500/40 active:scale-95">
                <i data-lucide="send" class="w-3.5 h-3.5"></i>
                <span>Test Alert</span>
            </button>

            <!-- User Profile Button -->
            <div id="user-profile" class="hidden flex items-center space-x-2 ml-4">
                <span id="user-name" class="text-sm text-slate-400"></span>
                <button onclick="logout()" class="flex items-center space-x-2 bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-3 rounded-lg transition-all">
                    <i data-lucide="log-out" class="w-3.5 h-3.5"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>

        <!-- Messages Area -->
        <div class="flex-1 overflow-y-auto p-6 pb-24" id="main-area">
            <div id="messages-container" class="space-y-4 max-w-4xl mx-auto">
                <!-- Messages injected here -->
            </div>
            
            <!-- Empty State -->
            <div id="empty-state" class="hidden flex flex-col items-center justify-center h-[60vh] text-slate-600">
                <div class="bg-slate-800/50 p-8 rounded-3xl mb-6 border border-slate-800">
                    <i data-lucide="radar" class="w-16 h-16 animate-pulse stroke-1"></i>
                </div>
                <p class="text-xl font-semibold text-slate-500">All systems operational</p>
                <p class="text-sm mt-2 text-slate-600">No active alerts in this channel</p>
            </div>

            <!-- Integration Guide (Hidden by default) -->
            <div id="integration-guide" class="hidden max-w-5xl mx-auto p-4">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-white mb-2">System Integration</h2>
                    <p class="text-slate-400">Connect your backend services to the Sentinel Network.</p>
                </div>
                <div class="grid gap-6 md:grid-cols-3 mb-8">
                    <div class="bg-slate-800/30 border border-slate-700/50 p-4 rounded-xl">
                        <div class="text-blue-500 text-xs font-bold uppercase tracking-wider mb-1">Endpoint</div>
                        <div class="font-semibold text-slate-200 mb-2">POST /webhook</div>
                        <code class="text-[10px] bg-slate-900 p-1 rounded text-slate-400 font-mono">Content-Type: application/json</code>
                    </div>
                    <div class="bg-slate-800/30 border border-slate-700/50 p-4 rounded-xl">
                        <div class="text-blue-500 text-xs font-bold uppercase tracking-wider mb-1">Payload</div>
                        <div class="font-semibold text-slate-200 mb-2">JSON Object</div>
                        <code class="text-[10px] bg-slate-900 p-1 rounded text-slate-400 font-mono">{ "title": "...", "message": "..." }</code>
                    </div>
                    <div class="bg-slate-800/30 border border-slate-700/50 p-4 rounded-xl">
                        <div class="text-blue-500 text-xs font-bold uppercase tracking-wider mb-1">Example</div>
                        <div class="font-semibold text-slate-200 mb-2">cURL</div>
                        <code class="text-[10px] bg-slate-900 p-1 rounded text-slate-400 font-mono">curl -X POST ...</code>
                    </div>
                </div>
                <div class="relative bg-[#0B1120] rounded-xl border border-slate-800 overflow-hidden">
                    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-800 bg-slate-900/50">
                        <div class="flex items-center space-x-2">
                            <div class="w-3 h-3 rounded-full bg-red-500/20 border border-red-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-yellow-500/20 border border-yellow-500/50"></div>
                            <div class="w-3 h-3 rounded-full bg-green-500/20 border border-green-500/50"></div>
                        </div>
                    </div>
                    <pre class="p-6 text-sm font-mono text-slate-300 overflow-x-auto leading-relaxed">
<span class="text-purple-400">curl</span> -X POST http://localhost:8080/webhook \
  -H <span class="text-green-400">"Content-Type: application/json"</span> \
  -d <span class="text-green-400">'{
    "source": "backend-api",
    "level": "error",
    "title": "Database Connection Failed",
    "message": "Connection timeout after 5000ms"
  }'</span></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Authentication State ---
        let isAuthenticated = false;
        let currentUser = null;
        let tempUserId = null; // For 2FA login flow

        // Check session on load
        function checkAuth() {
            const userId = localStorage.getItem('userId');
            const username = localStorage.getItem('username');
            const totpEnabled = localStorage.getItem('totpEnabled') === 'true';
            
            if (userId && username) {
                isAuthenticated = true;
                currentUser = { 
                    id: parseInt(userId), 
                    username,
                    totp_enabled: totpEnabled
                };
                updateProfileUI();
                lucide.createIcons();
            }
        }

        function updateProfileUI() {
            if (isAuthenticated && currentUser) {
                document.getElementById('user-profile').classList.remove('hidden');
                document.getElementById('user-name').textContent = currentUser.username;
                // Update profile modal fields
                document.getElementById('profile-username').value = currentUser.username;
                document.getElementById('profile-role').textContent = localStorage.getItem('userRole') || 'User';
                
                const statusEl = document.getElementById('profile-2fa-status');
                const btnEl = document.getElementById('btn-toggle-2fa');
                
                if (currentUser.totp_enabled) {
                    statusEl.textContent = 'Enabled âœ…';
                    statusEl.className = 'text-xs text-emerald-400 font-bold';
                    btnEl.textContent = 'Disable';
                    btnEl.className = 'text-xs font-bold px-3 py-1.5 rounded bg-red-600 hover:bg-red-500 text-white';
                    btnEl.onclick = disable2FA;
                } else {
                    statusEl.textContent = 'Disabled';
                    statusEl.className = 'text-xs text-slate-500';
                    btnEl.textContent = 'Setup';
                    btnEl.className = 'text-xs font-bold px-3 py-1.5 rounded bg-blue-600 hover:bg-blue-500 text-white';
                    btnEl.onclick = show2FASetupModal;
                }
            } else {
                document.getElementById('user-profile').classList.add('hidden');
            }
        }

        // --- Authentication Functions ---
        
        function showLoginOverlay() {
            document.getElementById('login-overlay').classList.remove('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('login-2fa-form').classList.add('hidden');
            document.getElementById('login-error').classList.add('hidden');
            lucide.createIcons();
        }

        function hideLoginOverlay() {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('login-username').value = '';
            document.getElementById('login-password').value = '';
            document.getElementById('login-2fa-code').value = '';
            document.getElementById('login-error').classList.add('hidden');
            tempUserId = null;
        }

        async function login(e) {
            e.preventDefault();
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            
            try {
                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    if (data.requires_2fa) {
                        // Switch to 2FA form
                        tempUserId = data.user_id;
                        document.getElementById('login-form').classList.add('hidden');
                        document.getElementById('login-2fa-form').classList.remove('hidden');
                        document.getElementById('login-error').classList.add('hidden');
                        document.getElementById('login-2fa-code').focus();
                    } else {
                        handleLoginSuccess(data);
                    }
                } else {
                    showLoginError(data.error || 'Invalid credentials');
                }
            } catch (err) {
                console.error('Login error:', err);
                showLoginError('Error: ' + err.message);
            }
        }

        async function verifyLogin2FA(e) {
            e.preventDefault();
            const code = document.getElementById('login-2fa-code').value;
            
            try {
                const res = await fetch('/api/login/verify-2fa', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: tempUserId, code })
                });
                
                const data = await res.json();
                
                if (res.ok) {
                    handleLoginSuccess(data);
                } else {
                    showLoginError('Invalid verification code');
                }
            } catch (err) {
                showLoginError('Error: ' + err.message);
            }
        }

        function cancel2FALogin() {
            document.getElementById('login-2fa-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
            document.getElementById('login-error').classList.add('hidden');
            tempUserId = null;
        }

        function handleLoginSuccess(data) {
            if (data.user) {
                localStorage.setItem('userId', data.user.id);
                localStorage.setItem('username', data.user.username);
                localStorage.setItem('userRole', data.user.role);
                localStorage.setItem('totpEnabled', data.user.totp_enabled || false); // Store 2FA status
                
                if (data.allowed_chats) {
                    localStorage.setItem('allowedChats', JSON.stringify(data.allowed_chats));
                }
                
                isAuthenticated = true;
                currentUser = { 
                    ...data.user,
                    totp_enabled: data.user.totp_enabled || false
                };
                
                updateProfileUI();
                hideLoginOverlay();
                
                loadChats();
                renderChannels();
                lucide.createIcons();
            }
        }

        function showLoginError(msg) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = msg;
            errorDiv.classList.remove('hidden');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.clear(); // Clear all
                isAuthenticated = false;
                currentUser = null;
                
                updateProfileUI();
                
                // Reset channels
                channels = [{ id: 'general', name: 'General', icon: 'hash' }];
                if (currentChannelId !== 'general' && currentChannelId !== 'integration') {
                    switchChannel('general');
                } else {
                    renderChannels();
                }
            }
        }

        // --- Profile Management ---

        // Add click handler to user profile button
        document.getElementById('user-profile').onclick = function(e) {
            // Only if clicking the name or container, not the logout button
            if (!e.target.closest('button')) {
                showProfileModal();
            }
        };

        // Also add a dedicated profile button next to logout
        // (Injecting this via JS to avoid modifying HTML structure too much if not needed)
        // Actually, let's just make the name clickable
        document.getElementById('user-name').className = "text-sm text-slate-400 hover:text-white cursor-pointer font-medium mr-2";
        document.getElementById('user-name').onclick = showProfileModal;

        function showProfileModal() {
            updateProfileUI(); // Refresh data
            document.getElementById('profile-modal').classList.remove('hidden');
            document.getElementById('profile-message').classList.add('hidden');
        }

        function hideProfileModal() {
            document.getElementById('profile-modal').classList.add('hidden');
        }

        async function updateUsername() {
            const newUsername = document.getElementById('profile-username').value;
            if (!newUsername) return;

            try {
                const res = await fetch('/api/user/profile', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id, username: newUsername })
                });

                if (res.ok) {
                    currentUser.username = newUsername;
                    localStorage.setItem('username', newUsername);
                    updateProfileUI();
                    showProfileMessage('Username updated successfully', 'text-emerald-400');
                } else {
                    showProfileMessage('Failed to update username', 'text-red-400');
                }
            } catch (err) {
                showProfileMessage('Error: ' + err.message, 'text-red-400');
            }
        }

        function showProfileMessage(msg, colorClass) {
            const el = document.getElementById('profile-message');
            el.textContent = msg;
            el.className = `mt-4 p-3 rounded-lg text-sm text-center bg-slate-900 ${colorClass}`;
            el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 3000);
        }

        // --- Password Management ---

        function showChangePasswordModal() {
            hideProfileModal();
            document.getElementById('password-modal').classList.remove('hidden');
            document.getElementById('pwd-old').value = '';
            document.getElementById('pwd-new').value = '';
            document.getElementById('pwd-confirm').value = '';
            document.getElementById('pwd-error').classList.add('hidden');
        }

        function hideChangePasswordModal() {
            document.getElementById('password-modal').classList.add('hidden');
            showProfileModal(); // Go back to profile
        }

        async function changePassword(e) {
            e.preventDefault();
            const oldPwd = document.getElementById('pwd-old').value;
            const newPwd = document.getElementById('pwd-new').value;
            const confirmPwd = document.getElementById('pwd-confirm').value;

            if (newPwd !== confirmPwd) {
                document.getElementById('pwd-error').textContent = "New passwords do not match";
                document.getElementById('pwd-error').classList.remove('hidden');
                return;
            }

            try {
                const res = await fetch('/api/user/change-password', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: currentUser.id, 
                        old_password: oldPwd,
                        new_password: newPwd 
                    })
                });

                if (res.ok) {
                    alert('Password changed successfully');
                    hideChangePasswordModal();
                } else {
                    const data = await res.json();
                    document.getElementById('pwd-error').textContent = data.error || "Failed to change password";
                    document.getElementById('pwd-error').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('pwd-error').textContent = "Error: " + err.message;
                document.getElementById('pwd-error').classList.remove('hidden');
            }
        }

        // --- 2FA Management ---

        async function show2FASetupModal() {
            hideProfileModal();
            document.getElementById('2fa-setup-modal').classList.remove('hidden');
            document.getElementById('2fa-error').classList.add('hidden');
            document.getElementById('2fa-verify-code').value = '';

            // Fetch new secret
            try {
                const res = await fetch('/api/user/2fa/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });
                
                const data = await res.json();
                document.getElementById('2fa-qr-code').src = data.qr_code;
                document.getElementById('2fa-secret').textContent = data.secret;
                
                // Store secret temporarily for verification
                currentUser.tempSecret = data.secret;
            } catch (err) {
                console.error('Failed to generate 2FA', err);
                alert('Failed to generate 2FA secret');
                hide2FASetupModal();
            }
        }

        function hide2FASetupModal() {
            document.getElementById('2fa-setup-modal').classList.add('hidden');
            showProfileModal();
        }

        async function enable2FA(e) {
            e.preventDefault();
            const code = document.getElementById('2fa-verify-code').value;
            
            try {
                const res = await fetch('/api/user/2fa/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        user_id: currentUser.id, 
                        secret: currentUser.tempSecret,
                        code: code 
                    })
                });

                if (res.ok) {
                    currentUser.totp_enabled = true;
                    localStorage.setItem('totpEnabled', 'true');
                    alert('Two-Factor Authentication Enabled! ðŸŽ‰');
                    hide2FASetupModal();
                } else {
                    document.getElementById('2fa-error').textContent = "Invalid code. Please try again.";
                    document.getElementById('2fa-error').classList.remove('hidden');
                }
            } catch (err) {
                document.getElementById('2fa-error').textContent = "Error: " + err.message;
                document.getElementById('2fa-error').classList.remove('hidden');
            }
        }

        async function disable2FA() {
            if (!confirm('Are you sure you want to disable 2FA? This will reduce your account security.')) return;

            try {
                const res = await fetch('/api/user/2fa/disable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ user_id: currentUser.id })
                });

                if (res.ok) {
                    currentUser.totp_enabled = false;
                    localStorage.setItem('totpEnabled', 'false');
                    updateProfileUI();
                    showProfileMessage('2FA Disabled', 'text-amber-400');
                } else {
                    alert('Failed to disable 2FA');
                }
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        // --- State ---
        checkAuth(); // Check authentication on load
        let channels = [
            { id: 'general', name: 'General', icon: 'hash' }
        ];
        let currentChannelId = 'general';
        let alerts = [];

        // Load chats from API
        async function loadChats() {
            try {
                const res = await fetch('/api/chats');
                const data = await res.json();
                const allChats = data.chats || [];
                
                // Get user role and allowed chats
                const userRole = localStorage.getItem('userRole');
                const allowedChatsStr = localStorage.getItem('allowedChats');
                const allowedChats = allowedChatsStr ? JSON.parse(allowedChatsStr) : [];
                
                // Filter chats based on permissions
                let chatsToShow = allChats;
                if (userRole !== 'admin' && allowedChats.length > 0) {
                    // Regular user: only show assigned chats
                    chatsToShow = allChats.filter(chat => 
                        allowedChats.some(allowed => allowed.chat_id === chat.chat_id)
                    );
                }
                // Admin users see all chats (no filtering needed)
                
                // Reset channels to General
                channels = [{ id: 'general', name: 'General', icon: 'hash' }];
                
                // Add filtered chats as channels
                chatsToShow.forEach(chat => {
                    channels.push({
                        id: chat.chat_id,
                        name: chat.name,
                        icon: 'message-square',
                        chatData: chat
                    });
                });
                
                renderChannels();
            } catch (err) {
                console.error('Failed to load chats:', err);
            }
        }

        // Initialize all alerts locally
        let searchQuery = '';
        let searchTimeout = null;

        // --- Initialization ---
        lucide.createIcons();
        loadChats();
        renderChannels();
        
        // Search input listener with debounce
        document.getElementById('search-input').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchQuery = e.target.value;
            
            searchTimeout = setTimeout(() => {
                if (searchQuery.trim()) {
                    performSearch(searchQuery);
                } else {
                    renderMessages(); // Reset to all alerts
                }
            }, 300);
        });
        
        // Pre-load alerts from server-side template if available
        // (We are using JS to fetch/render for simplicity with SSE, but we could hydrate)
        {{ if .Alerts }}
        const initialAlerts = {{ .Alerts }};
        if (initialAlerts) {
            alerts = initialAlerts;
            renderMessages();
        }
        {{ end }}

        // --- SSE Connection ---
        const evtSource = new EventSource("/events");
        
        evtSource.onopen = () => {
            updateStatus('connected');
        };

        evtSource.onerror = () => {
            updateStatus('disconnected');
        };

        evtSource.onmessage = (event) => {
            if (event.data === "connected") return;
            try {
                const alert = JSON.parse(event.data);
                alerts.unshift(alert); // Add to top
                renderMessages();
                
                // Optional: Notification sound or browser notification
            } catch (e) {
                console.error("Failed to parse alert", e);
            }
        };

        // --- Functions ---

        function updateStatus(status) {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            
            if (status === 'connected') {
                dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
                text.textContent = "System Online";
                text.className = "text-[10px] uppercase tracking-wider font-bold text-slate-400";
            } else {
                dot.className = "w-2 h-2 rounded-full bg-red-500";
                text.textContent = "Offline";
                text.className = "text-[10px] uppercase tracking-wider font-bold text-red-500";
            }
        }

        function renderChannels() {
            const container = document.getElementById('channel-list');
            container.innerHTML = channels.map(ch => {
                const isProtected = ch.id !== 'general';
                const isLocked = isProtected && !isAuthenticated;
                
                return `
                <button onclick="switchChannel('${ch.id}')" 
                    class="w-full flex items-center justify-between px-3 py-2.5 rounded-lg transition-all duration-200 group ${currentChannelId === ch.id ? 'bg-blue-600/10 text-blue-400 border border-blue-600/20' : 'text-slate-400 hover:bg-slate-800/50 hover:text-slate-200'}">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="${ch.icon || 'hash'}" class="w-4 h-4 opacity-70 ${currentChannelId === ch.id ? 'text-blue-400' : 'text-slate-500 group-hover:text-slate-400'}"></i>
                        <span class="font-medium text-sm">${ch.name}</span>
                    </div>
                    ${isLocked ? '<i data-lucide="lock" class="w-3.5 h-3.5 text-slate-500"></i>' : ''}
                </button>
            `}).join('');
            lucide.createIcons();
        }

        function switchChannel(id) {
            // Check authentication for non-general channels
            if (id !== 'general' && id !== 'integration' && !isAuthenticated) {
                showLoginOverlay();
                return;
            }
            
            currentChannelId = id;
            
            // Update UI state
            document.getElementById('btn-integration').className = `w-full flex items-center justify-center space-x-2 px-4 py-3 rounded-lg text-sm font-medium transition-all ${id === 'integration' ? 'bg-slate-800 text-white shadow-inner' : 'bg-slate-800/50 text-slate-400 hover:bg-slate-800 hover:text-white'}`;
            
            renderChannels(); // Re-render to update active state

            const headerTitle = document.getElementById('header-title');
            const headerIcon = document.getElementById('header-icon');
            const testBtn = document.getElementById('test-btn');
            const msgsContainer = document.getElementById('messages-container');
            const emptyState = document.getElementById('empty-state');
            const integrationGuide = document.getElementById('integration-guide');

            if (id === 'integration') {
                headerTitle.textContent = "Integration Guide";
                headerIcon.style.display = 'none';
                testBtn.style.display = 'none';
                msgsContainer.style.display = 'none';
                emptyState.style.display = 'none';
                integrationGuide.style.display = 'block';
            } else {
                const ch = channels.find(c => c.id === id);
                headerTitle.textContent = ch ? ch.name : 'Unknown';
                headerIcon.style.display = 'inline-block';
                testBtn.style.display = 'flex';
                msgsContainer.style.display = 'block';
                integrationGuide.style.display = 'none';
                renderMessages();
            }
        }

        function renderMessages() {
            if (currentChannelId === 'integration') return;

            const container = document.getElementById('messages-container');
            
            // Filter alerts based on current channel
            const filtered = alerts.filter(a => {
                if (currentChannelId === 'general') {
                    // General shows all alerts that are NOT specifically for a chat
                    return !a.source.includes(':chat:');
                }
                
                // For chat channels, filter by chat_id in source
                // Source format: "bot:{botName}:chat:{chatId}"
                const chatMatch = a.source.match(/:chat:([^:]+)/);
                if (chatMatch && chatMatch[1] === currentChannelId) {
                    return true;
                }
                
                return false;
            });

            if (filtered.length === 0) {
                container.innerHTML = '';
                document.getElementById('empty-state').classList.remove('hidden');
                return;
            }
            
            document.getElementById('empty-state').classList.add('hidden');
            
            container.innerHTML = filtered.map(msg => {
                const styles = getAlertStyles(msg.level);
                const date = new Date(msg.created_at).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                return `
                <div class="mb-3 rounded-xl p-5 border ${styles.bg} ${styles.border} shadow-sm hover:shadow-md transition-shadow duration-300 animate-fade-in w-full">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center space-x-2.5">
                            ${styles.icon}
                            <span class="font-semibold tracking-wide ${styles.title}">${msg.title || 'System Alert'}</span>
                        </div>
                        <span class="text-[11px] text-slate-500 font-medium uppercase tracking-wider">${date}</span>
                    </div>
                    <div class="text-slate-300 text-sm leading-relaxed font-light pl-7 whitespace-pre-wrap">${msg.message}</div>
                    <div class="mt-4 ml-7 pt-3 border-t border-slate-700/30">
                        <div class="flex items-center space-x-2 text-[10px] text-slate-500 uppercase tracking-wider mb-1">
                            <i data-lucide="activity" class="w-3 h-3"></i>
                            <span>Source: ${msg.source}</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
            
            lucide.createIcons();
        }

        function getAlertStyles(level) {
            level = (level || '').toLowerCase();
            if (level.includes('crit') || level.includes('err') || level.includes('fail')) {
                return { 
                    bg: 'bg-red-500/5', 
                    border: 'border-red-500/20', 
                    title: 'text-red-400',
                    icon: `<i data-lucide="x-circle" class="text-red-500 w-4.5 h-4.5"></i>`
                };
            }
            if (level.includes('warn')) {
                return { 
                    bg: 'bg-amber-500/5', 
                    border: 'border-amber-500/20', 
                    title: 'text-amber-400',
                    icon: `<i data-lucide="alert-triangle" class="text-amber-500 w-4.5 h-4.5"></i>`
                };
            }
            if (level.includes('success') || level.includes('ok')) {
                return { 
                    bg: 'bg-emerald-500/5', 
                    border: 'border-emerald-500/20', 
                    title: 'text-emerald-400',
                    icon: `<i data-lucide="check-circle" class="text-emerald-500 w-4.5 h-4.5"></i>`
                };
            }
            return { 
                bg: 'bg-slate-800/40', 
                border: 'border-slate-700/50', 
                title: 'text-blue-400',
                icon: `<i data-lucide="info" class="text-blue-400 w-4.5 h-4.5"></i>`
            };
        }

        async function performSearch(query) {
            try {
                const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.alerts) {
                    alerts = data.alerts;
                    renderMessages();
                }
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        function sendTestAlert() {
            const titles = ["Latency Spike Detected", "Pod Restarted", "API Rate Limit Exceeded", "Backup Completed"];
            const levels = ['critical', 'warning', 'warning', 'success'];
            const rand = Math.floor(Math.random() * titles.length);
            
            fetch('/webhook', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    title: titles[rand],
                    message: `Automated test alert generated at ${new Date().toISOString()}`,
                    level: levels[rand],
                    source: 'ui-test'
                })
            }).catch(console.error);
        }
    </script>
</body>
</html>
